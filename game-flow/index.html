<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flow Master - Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');

        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            overscroll-behavior: none;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            overflow: hidden;
        }

        .hidden-important { display: none !important; }
        
        /* Layering Fix: Ensure Menu is ALWAYS on top of particles */
        #particles-bg { z-index: 0; pointer-events: none; }
        #main-menu, #game-ui, #modals-container { z-index: 10; position: relative; }
        #modals-container { z-index: 100; }

        canvas {
            border-radius: 12px;
            cursor: crosshair;
            display: block;
            touch-action: none; /* Critical for gameplay */
        }

        .btn { transition: transform 0.1s; cursor: pointer; }
        .btn:active { transform: scale(0.95); }

        /* Animation Keyframes */
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
        .anim-float { animation: float 3s ease-in-out infinite; }
        
        @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }
        .anim-pulse { animation: pulse 2s infinite; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center bg-slate-900">

    <!-- LAYER 0: BACKGROUND -->
    <div id="particles-bg" class="absolute inset-0 overflow-hidden">
        <div class="absolute top-10 left-10 w-32 h-32 bg-blue-500/20 rounded-full blur-3xl anim-float"></div>
        <div class="absolute bottom-10 right-10 w-40 h-40 bg-pink-500/20 rounded-full blur-3xl anim-float" style="animation-delay:1s"></div>
    </div>

    <!-- LAYER 1: MAIN MENU -->
    <div id="main-menu" class="absolute inset-0 flex flex-col items-center justify-center w-full px-6 text-center">
        <!-- Tombol Kembali (Link HTML Murni) -->
        <a href="../index.html" class="absolute top-6 left-6 text-slate-400 hover:text-white flex items-center gap-2 font-bold bg-slate-800 px-4 py-2 rounded-full z-50">
            <i class="fas fa-arrow-left"></i> Menu Utama
        </a>

        <div class="mb-10 anim-float">
            <h1 class="text-6xl font-black tracking-tighter drop-shadow-lg mb-2">
                <span class="text-blue-500">FLOW</span>
            </h1>
            <h1 class="text-6xl font-black tracking-tighter drop-shadow-lg">
                <span class="text-pink-500">MASTER</span>
            </h1>
            <p class="mt-4 text-xs font-bold tracking-widest text-slate-500">CHALLENGE EDITION</p>
        </div>

        <div class="w-full max-w-xs space-y-4">
            <!-- Onclick langsung mengarah ke fungsi global -->
            <button onclick="app.startGame()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-xl shadow-lg btn border-b-4 border-blue-800 flex items-center justify-center gap-2 anim-pulse">
                <i class="fas fa-play"></i> MAINKAN
            </button>
            <button onclick="app.showLeaderboard()" class="w-full bg-slate-700 text-white py-4 rounded-2xl font-bold text-lg shadow-lg btn border-b-4 border-slate-800">
                <i class="fas fa-trophy text-yellow-400 mr-2"></i> REKOR
            </button>
        </div>
        <div class="mt-8 text-slate-600 text-xs font-mono" id="version-tag">v2.1 ‚Ä¢ Ready</div>
    </div>

    <!-- LAYER 2: GAMEPLAY UI -->
    <div id="game-ui" class="hidden-important absolute inset-0 flex flex-col items-center bg-slate-900 w-full h-full">
        <!-- Top Bar -->
        <div class="w-full max-w-md px-4 pt-4 pb-2 flex items-center justify-between z-20">
            <button onclick="app.quitGame()" class="w-10 h-10 rounded-full bg-slate-800 text-slate-400 btn flex items-center justify-center border border-slate-700">
                <i class="fas fa-home"></i>
            </button>
            <div class="flex gap-2">
                <div class="bg-slate-800 px-3 py-1 rounded-lg border border-slate-700 text-center">
                    <div class="text-[10px] text-slate-400 font-bold">LEVEL</div>
                    <div id="ui-level" class="text-white font-bold leading-none">1</div>
                </div>
                <div id="ui-moves-box" class="bg-slate-800 px-3 py-1 rounded-lg border border-slate-700 text-center">
                    <div class="text-[10px] text-slate-400 font-bold">MOVES</div>
                    <div id="ui-moves" class="text-white font-bold leading-none">0</div>
                </div>
                <div class="bg-slate-800 px-3 py-1 rounded-lg border border-slate-700 text-center">
                    <div class="text-[10px] text-slate-400 font-bold">SCORE</div>
                    <div id="ui-score" class="text-emerald-400 font-bold leading-none">0</div>
                </div>
            </div>
        </div>

        <!-- Canvas Container -->
        <div class="flex-1 flex items-center justify-center w-full px-4 relative z-10">
            <div id="game-wrapper" class="bg-slate-800 rounded-2xl shadow-2xl p-2 relative">
                <canvas id="gameCanvas"></canvas>
                <div class="absolute -top-3 -right-2 bg-slate-900 border border-slate-600 px-2 py-1 rounded text-xs font-mono text-slate-300 shadow-sm pointer-events-none">
                    <i class="fas fa-clock mr-1 text-slate-500"></i><span id="ui-timer">0s</span>
                </div>
            </div>
        </div>

        <!-- Bottom Controls -->
        <div class="w-full max-w-md px-6 pb-8 pt-4 flex gap-4 z-20">
            <button onclick="app.resetLevel()" class="flex-1 bg-slate-700 text-white py-3 rounded-xl font-bold border-b-4 border-slate-800 btn">
                <i class="fas fa-undo mr-1"></i> ULANG
            </button>
            <button id="btn-next" onclick="app.nextLevel()" disabled class="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold border-b-4 border-emerald-800 btn opacity-50 cursor-not-allowed">
                LANJUT <i class="fas fa-arrow-right ml-1"></i>
            </button>
        </div>
    </div>

    <!-- LAYER 3: MODALS (Overlays) -->
    <div id="modals-container" class="hidden-important fixed inset-0 bg-slate-900/95 flex items-center justify-center p-4 backdrop-blur-sm">
        
        <!-- Win Modal -->
        <div id="modal-win" class="hidden-important bg-slate-800 p-8 rounded-3xl w-full max-w-sm text-center border-2 border-emerald-500 shadow-2xl">
            <div class="text-5xl mb-4">üéâ</div>
            <h2 class="text-2xl font-bold text-white mb-2">Level Selesai!</h2>
            <div class="bg-slate-900/50 rounded-xl p-4 mb-6 text-sm">
                <div class="flex justify-between text-slate-300"><span>Bonus Langkah</span><span id="modal-bonus" class="text-yellow-400 font-bold">+0</span></div>
            </div>
            <button onclick="app.nextLevel()" class="w-full bg-emerald-500 text-white py-3 rounded-xl font-bold shadow-lg btn">Level Berikutnya</button>
        </div>

        <!-- Game Over Modal -->
        <div id="modal-gameover" class="hidden-important bg-slate-800 p-8 rounded-3xl w-full max-w-sm text-center border-2 border-red-500 shadow-2xl">
            <div class="text-5xl mb-4">üíÄ</div>
            <h2 class="text-2xl font-bold text-red-500 mb-2">GAME OVER</h2>
            <p class="text-slate-300 mb-6">Langkah Habis!</p>
            <button onclick="app.resetLevel()" class="w-full bg-slate-700 text-white py-3 rounded-xl font-bold shadow-lg btn mb-3">Coba Lagi</button>
            <button onclick="app.quitGame()" class="text-slate-500 text-sm font-bold">KEMBALI KE MENU</button>
        </div>

        <!-- Leaderboard Modal -->
        <div id="modal-leaderboard" class="hidden-important bg-slate-800 p-6 rounded-3xl w-full max-w-sm h-[80%] flex flex-col border border-slate-700">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-yellow-400">üèÜ Top 10</h3>
                <button onclick="app.hideModals()" class="w-8 h-8 rounded-full bg-slate-700 text-white btn">‚úï</button>
            </div>
            <div class="flex-1 overflow-y-auto bg-slate-900/50 rounded-xl p-2">
                <table class="w-full text-sm text-left text-slate-300">
                    <thead><tr><th class="p-2">#</th><th class="p-2">Nama</th><th class="p-2 text-right">Skor</th></tr></thead>
                    <tbody id="list-leaderboard"></tbody>
                </table>
            </div>
        </div>

        <!-- Submit Score Modal -->
        <div id="modal-submit" class="hidden-important bg-slate-800 p-8 rounded-3xl w-full max-w-sm text-center border-2 border-blue-500">
            <h2 class="text-3xl font-black text-white mb-2">TAMAT!</h2>
            <div id="final-score-disp" class="text-4xl font-bold text-blue-400 mb-6 bg-slate-900 rounded-lg py-2">0</div>
            <input id="input-name" type="text" placeholder="NAMA ANDA" maxlength="10" class="w-full bg-slate-900 border border-slate-600 rounded-xl p-3 text-white text-center mb-4 font-bold uppercase">
            <button onclick="app.saveScore()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg btn">SIMPAN</button>
        </div>

    </div>

<script>
/**
 * APP CONTROLLER
 * Menggunakan pola Module tunggal yang diekspos ke window.app
 * untuk menghindari konflik scope dan memastikan tombol HTML berfungsi.
 */
(function() {
    // --- DATA LEVEL ---
    const BASE_LEVELS = [
        { size: 5, grid: [[1,0,0,0,2],[0,0,0,0,2],[0,3,3,0,0],[4,0,0,0,0],[4,0,1,5,5]] },
        { size: 5, grid: [[4,4,0,0,1],[0,0,3,0,0],[1,0,3,0,0],[5,0,0,0,0],[5,0,0,2,2]] },
        { size: 6, grid: [[1,0,0,2,0,0],[0,0,0,2,0,0],[0,3,4,0,0,0],[0,3,4,0,5,0],[0,0,0,0,5,0],[1,0,0,0,0,0]] },
        { size: 6, grid: [[1,0,0,0,0,1],[0,0,3,3,0,0],[0,0,4,4,0,0],[0,0,0,0,2,2],[0,5,5,0,0,0],[0,0,0,0,0,0]] },
        { size: 7, grid: [[1,0,0,0,0,0,2],[0,0,3,0,0,0,2],[0,0,3,0,4,0,0],[0,5,0,0,4,0,0],[0,5,0,0,0,0,6],[0,0,0,0,0,0,6],[1,0,0,0,0,0,0]] },
        { size: 7, grid: [[2,0,0,0,0,0,1],[2,0,0,0,3,0,0],[0,0,4,0,3,0,0],[0,0,4,0,0,5,0],[6,0,0,0,0,5,0],[6,0,0,0,0,0,0],[0,0,0,0,0,0,1]] },
        { size: 8, grid: [[1,0,0,0,0,0,2,0],[0,0,3,3,0,0,2,0],[0,0,4,0,0,0,0,0],[0,0,4,0,5,5,0,0],[0,0,0,0,0,0,0,0],[6,6,0,7,7,0,8,8],[0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0]] },
        { size: 8, grid: [[1,2,0,0,0,0,3,4],[1,2,0,0,0,0,3,4],[0,0,0,0,0,0,0,0],[0,5,5,0,0,6,6,0],[0,7,7,0,0,8,8,0],[0,0,0,0,0,0,0,0],[0,0,9,9,0,0,0,0],[0,0,0,0,0,0,0,0]] },
        { size: 9, grid: [[1,0,0,0,2,0,0,0,3],[0,0,0,0,2,0,0,0,3],[0,0,4,4,0,5,5,0,0],[0,0,0,0,0,0,0,0,0],[0,0,6,6,0,7,7,0,0],[0,0,0,0,0,0,0,0,0],[0,8,8,0,9,9,0,0,0],[0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0]] }
    ];
    const LEVEL_10 = { size: 9, grid: [[1,0,0,2,0,0,0,3,0],[1,0,0,2,0,4,4,3,0],[0,5,5,0,0,0,0,0,0],[0,6,6,0,7,7,0,8,8],[0,0,0,0,0,0,0,0,0],[0,9,9,0,0,0,0,0,0],[0,0,0,0,10,10,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0]] };

    // --- GAME ENGINE ---
    const Game = {
        canvas: null,
        ctx: null,
        levels: [],
        
        // Game State
        lvlIdx: 0,
        score: 0,
        gridSize: 0,
        cellSize: 0,
        sources: [],
        paths: {}, // { colorId: [{x,y},...] }
        movesLeft: 0,
        isPlaying: false,
        isOver: false,
        
        // Input
        activeColor: null,
        isDragging: false,
        
        // Config
        colors: ['#ef4444', '#3b82f6', '#22c55e', '#eab308', '#d946ef', '#f97316', '#06b6d4', '#94a3b8', '#8b5cf6', '#ec4899', '#14b8a6', '#84cc16'],
        timerId: null,
        startTime: 0,

        init() {
            this.canvas = document.getElementById('gameCanvas');
            this.ctx = this.canvas.getContext('2d');
            this.generateLevels();
            this.resize();
            window.addEventListener('resize', () => this.resize());
            this.bindInput();
        },

        generateLevels() {
            // Helpers
            const rot = g=>{const n=g.length,r=Array.from({length:n},()=>Array(n).fill(0));for(let i=0;i<n;i++)for(let j=0;j<n;j++)r[j][n-1-i]=g[i][j];return r};
            const flip = g=>g.map(r=>[...r].reverse());
            const remap = g=>{
                const s=new Set();g.flat().forEach(v=>v>0&&s.add(v));
                const m={},a=[...s].sort(()=>Math.random()-.5);
                [...s].forEach((id,i)=>m[id]=a[i]);
                return g.map(r=>r.map(v=>m[v]||0));
            };

            this.levels = [...BASE_LEVELS, LEVEL_10];
            const srcIdx = [4,5,6,7,8,9]; // Use harder levels as base
            
            for(let i=10; i<50; i++) {
                try {
                    const base = this.levels[srcIdx[i % srcIdx.length]];
                    let g = JSON.parse(JSON.stringify(base.grid));
                    for(let k=0;k<(i%4);k++) g = rot(g);
                    if(i%2===0) g = flip(g);
                    this.levels.push({ size: base.size, grid: remap(g) });
                } catch(e) { console.error("Gen error", e); }
            }
        },

        resize() {
            const wrap = document.getElementById('game-wrapper');
            const maxW = Math.min(window.innerWidth - 32, 400);
            this.canvas.style.width = maxW + 'px';
            this.canvas.style.height = maxW + 'px';
            this.canvas.width = maxW * window.devicePixelRatio;
            this.canvas.height = maxW * window.devicePixelRatio;
            this.ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            
            if(this.gridSize > 0) {
                this.cellSize = maxW / this.gridSize;
                this.render();
            }
        },

        start() {
            document.getElementById('main-menu').classList.add('hidden-important');
            document.getElementById('game-ui').classList.remove('hidden-important');
            this.score = 0;
            this.loadLevel(0);
        },

        loadLevel(idx) {
            if(idx >= this.levels.length) { app.showSubmit(); return; }
            
            this.lvlIdx = idx;
            const data = this.levels[idx];
            this.gridSize = data.size;
            
            // Logic Reset
            this.sources = [];
            this.paths = {};
            this.isOver = false;
            this.activeColor = null;
            this.isDragging = false;
            this.isPlaying = true;
            
            // UI Reset
            this.hideModals();
            this.resize(); // Recalc cell size
            
            const colors = new Set();
            data.grid.forEach((row, y) => row.forEach((val, x) => {
                if(val > 0) {
                    this.sources.push({x, y, color: val});
                    colors.add(val);
                }
            }));
            
            this.movesLeft = colors.size + 5;
            
            // UI Text
            document.getElementById('ui-level').innerText = idx + 1;
            document.getElementById('ui-score').innerText = this.score;
            document.getElementById('btn-next').disabled = true;
            document.getElementById('btn-next').classList.add('opacity-50', 'cursor-not-allowed');
            
            this.updateMovesUI();
            this.startTimer();
            this.render();
        },

        updateMovesUI() {
            const el = document.getElementById('ui-moves');
            const box = document.getElementById('ui-moves-box');
            el.innerText = this.movesLeft;
            if(this.movesLeft <= 3) box.className = "bg-red-900/50 px-3 py-1 rounded-lg border border-red-500 text-center animate-pulse";
            else box.className = "bg-slate-800 px-3 py-1 rounded-lg border border-slate-700 text-center";
        },

        startTimer() {
            clearInterval(this.timerId);
            this.startTime = Date.now();
            const el = document.getElementById('ui-timer');
            el.innerText = "0s";
            this.timerId = setInterval(() => {
                const s = Math.floor((Date.now() - this.startTime)/1000);
                el.innerText = s + 's';
            }, 1000);
        },

        // --- INPUT HANDLING ---
        bindInput() {
            const cvs = this.canvas;
            
            const getPos = (e) => {
                const rect = cvs.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: Math.floor((clientX - rect.left) / this.cellSize),
                    y: Math.floor((clientY - rect.top) / this.cellSize)
                };
            };

            const start = (e) => {
                if(!this.isPlaying || this.isOver) return;
                const p = getPos(e);
                if(this.isOutOfBounds(p)) return;

                const src = this.sources.find(s => s.x === p.x && s.y === p.y);
                
                // Click existing path?
                let pathCol = null;
                if(!src) {
                    for(const [c, path] of Object.entries(this.paths)) {
                        if(path.some(pt => pt.x === p.x && pt.y === p.y)) { pathCol = parseInt(c); break; }
                    }
                }

                if(src) {
                    this.activeColor = src.color;
                    this.paths[this.activeColor] = [{x:p.x, y:p.y}];
                    this.isDragging = true;
                    this.render();
                } else if(pathCol) {
                    this.activeColor = pathCol;
                    // Truncate
                    const path = this.paths[pathCol];
                    const idx = path.findIndex(pt => pt.x === p.x && pt.y === p.y);
                    if(idx !== -1) this.paths[pathCol] = path.slice(0, idx+1);
                    this.isDragging = true;
                    this.render();
                }
            };

            const move = (e) => {
                if(!this.isDragging || !this.isPlaying || this.isOver) return;
                e.preventDefault(); // Prevent scroll on mobile
                const p = getPos(e);
                if(this.isOutOfBounds(p)) return;

                const path = this.paths[this.activeColor];
                const last = path[path.length-1];

                // Logic: Must be adjacent, no diagonal
                if(Math.abs(p.x - last.x) + Math.abs(p.y - last.y) !== 1) {
                    // Backtrack check
                    if(path.length > 1 && path[path.length-2].x === p.x && path[path.length-2].y === p.y) {
                        path.pop(); this.render();
                    }
                    return;
                }

                // Collision
                const hitSrc = this.sources.find(s => s.x === p.x && s.y === p.y);
                if(hitSrc && hitSrc.color !== this.activeColor) return;
                
                for(const [c, ph] of Object.entries(this.paths)) {
                    // Self collision allowed only for backtrack (handled above), else block
                    if(ph.some(pt => pt.x === p.x && pt.y === p.y)) return;
                }

                path.push({x:p.x, y:p.y});
                this.render();

                // Snap
                if(hitSrc && hitSrc.color === this.activeColor) {
                 
