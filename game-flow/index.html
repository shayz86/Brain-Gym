<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flow Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');

        /* 1. LAYOUT RESET */
        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background-color: #0f172a;
            color: white;
            font-family: 'Fredoka', sans-serif;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            /* PENTING: Izinkan touch default agar tombol bisa diklik */
            touch-action: manipulation; 
        }

        /* 2. CONTAINER */
        #main-container {
            width: 100%; height: 100%;
            position: relative;
            display: flex; justify-content: center; align-items: center;
        }

        /* 3. LAYAR (SCREENS) */
        .screen {
            position: absolute; inset: 0;
            width: 100%; height: 100%;
            background-color: #0f172a;
            display: none; /* Default sembunyi */
            flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 10;
        }
        
        /* Class untuk menampilkan layar */
        .screen.show {
            display: flex;
            z-index: 50; /* Paling atas */
        }

        /* 4. CANVAS */
        canvas {
            background: #1e293b;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            touch-action: none; /* Matikan touch browser HANYA di canvas */
            cursor: crosshair;
        }

        /* 5. TOMBOL (Styles) */
        .btn {
            cursor: pointer;
            transition: transform 0.1s;
            position: relative;
            z-index: 100;
        }
        .btn:active { transform: scale(0.95); opacity: 0.9; }
        
        .text-gradient {
            background: linear-gradient(to right, #3b82f6, #ec4899);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div id="main-container">

        <div id="menu-screen" class="screen show">
            <a href="../index.html" class="absolute top-6 left-6 bg-slate-800 px-4 py-2 rounded-full text-slate-300 font-bold text-sm no-underline btn">
                <i class="fas fa-arrow-left mr-2"></i> Menu
            </a>

            <div class="mb-10 text-center">
                <h1 class="text-6xl font-bold leading-tight">
                    <span class="text-blue-500 block">FLOW</span>
                    <span class="text-pink-500 block">MASTER</span>
                </h1>
                <div class="mt-4 bg-slate-800 px-3 py-1 rounded-full border border-slate-700 inline-block">
                    <span class="text-xs font-bold text-slate-400">PUZZLE EDITION</span>
                </div>
            </div>

            <div class="w-full max-w-xs space-y-4">
                <button onclick="startGame()" class="btn w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-xl shadow-lg border-b-4 border-blue-800 flex items-center justify-center gap-3">
                    <i class="fas fa-play"></i> MAINKAN
                </button>
                
                <button onclick="showLeaderboard()" class="btn w-full bg-slate-700 text-white py-4 rounded-2xl font-bold text-lg shadow-lg border-b-4 border-slate-900 flex items-center justify-center gap-3">
                    <i class="fas fa-trophy text-yellow-500"></i> SKOR
                </button>
            </div>
            <div class="mt-8 text-slate-600 text-xs font-mono">V12.0 â€¢ SAFE MODE</div>
        </div>

        <div id="game-screen" class="screen">
            <div class="w-full max-w-md flex justify-between items-center mb-4 px-4">
                <button onclick="goHome()" class="btn w-12 h-12 bg-slate-800 rounded-full text-slate-400 border border-slate-700 text-xl"><i class="fas fa-home"></i></button>
                <div class="text-center">
                    <h2 class="text-xl font-bold text-white tracking-widest">LEVEL <span id="disp-level">1</span></h2>
                    <div class="text-xs text-emerald-400 font-mono" id="disp-timer">00:00</div>
                </div>
                <button onclick="resetGame()" class="btn w-12 h-12 bg-slate-800 rounded-full text-slate-400 border border-slate-700 text-xl"><i class="fas fa-undo"></i></button>
            </div>

            <div class="relative p-2 bg-slate-800/50 rounded-2xl border border-slate-700 shadow-2xl">
                <canvas id="gameCanvas" width="350" height="350"></canvas>
                
                <div id="win-overlay" class="absolute inset-0 bg-slate-900/95 backdrop-blur-sm rounded-xl flex flex-col items-center justify-center hidden z-50">
                    <i class="fas fa-check-circle text-6xl text-emerald-500 mb-4 animate-bounce"></i>
                    <h2 class="text-2xl font-bold text-white mb-2">SELESAI!</h2>
                    <p class="text-slate-400 mb-6 text-sm">Semua kotak terisi.</p>
                    <button onclick="nextLevel()" class="btn bg-emerald-500 text-white px-8 py-3 rounded-full font-bold shadow-lg border-b-4 border-emerald-700">
                        LANJUT <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <div class="mt-6 text-center text-slate-500 text-sm font-medium px-4">
                Hubungkan warna & penuhi seluruh kotak!
            </div>
        </div>

        <div id="lb-screen" class="screen">
            <h2 class="text-2xl font-bold text-yellow-500 mb-6 flex items-center gap-2">
                <i class="fas fa-trophy"></i> TOP SKOR
            </h2>
            <div class="bg-slate-800 w-full max-w-md rounded-2xl border border-slate-700 overflow-hidden flex flex-col shadow-2xl h-[60vh]">
                <div class="grid grid-cols-3 bg-slate-900 p-4 font-bold text-xs uppercase text-slate-400">
                    <div class="text-center">#</div> <div>Nama</div> <div class="text-right">Level</div>
                </div>
                <div id="lb-list" class="overflow-y-auto p-0 flex-1 hide-scroll"></div>
            </div>
            <button onclick="goHome()" class="btn mt-6 px-10 py-3 bg-slate-700 rounded-full font-bold text-white shadow-lg border-b-4 border-slate-900">
                TUTUP
            </button>
        </div>

    </div>

    <script>
        // --- 1. DATA ---
        const COLORS = {
            1: '#ef4444', 2: '#3b82f6', 3: '#22c55e', 4: '#eab308', 
            5: '#d946ef', 6: '#f97316', 7: '#06b6d4', 8: '#94a3b8'
        };
        const LEVELS = [
            { size: 5, grid: [[1,0,0,0,2],[0,0,0,0,2],[0,3,3,0,0],[4,0,0,0,0],[4,0,1,5,5]] },
            { size: 5, grid: [[4,4,0,0,1],[0,0,3,0,0],[1,0,3,0,0],[5,0,0,0,0],[5,0,0,2,2]] },
            { size: 6, grid: [[1,0,0,2,0,0],[0,0,0,2,0,0],[0,3,4,0,0,0],[0,3,4,0,5,0],[0,0,0,0,5,0],[1,0,0,0,0,0]] },
            { size: 6, grid: [[1,0,0,0,0,1],[0,0,3,3,0,0],[0,0,4,4,0,0],[0,0,0,0,2,2],[0,5,5,0,0,0],[0,0,0,0,0,0]] },
            { size: 7, grid: [[1,0,0,0,0,0,2],[0,0,3,0,0,0,2],[0,0,3,0,4,0,0],[0,5,0,0,4,0,0],[0,5,0,0,0,0,6],[0,0,0,0,0,0,6],[1,0,0,0,0,0,0]] }
        ];

        // --- 2. GLOBAL STATE ---
        var currentLevel = 0;
        var gameGrid = [];
        var gamePaths = {};
        var activeColor = null;
        var isCompleted = false;
        var timerInterval = null;
        var startTime = 0;
        
        var canvas = null;
        var ctx = null;
        var cellSize = 0;
        var gridSize = 5;

        // --- 3. INIT (SAAT LOAD) ---
        window.onload = function() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // Setup Input Canvas
            canvas.addEventListener('mousedown', inputStart);
            canvas.addEventListener('mousemove', inputMove);
            window.addEventListener('mouseup', inputEnd);
            
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault(); // Cegah scroll
                inputStart(e.touches[0]);
            }, {passive: false});
            
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
                inputMove(e.touches[0]);
            }, {passive: false});
            
            window.addEventListener('touchend', inputEnd);
            window.addEventListener('resize', resizeGame);
        };

        // --- 4. NAVIGATION FUNCTIONS (GLOBAL) ---
        window.showScreen = function(id) {
            // Sembunyikan semua
            document.getElementById('menu-screen').classList.remove('show');
            document.getElementById('game-screen').classList.remove('show');
            document.getElementById('lb-screen').classList.remove('show');
            
            // Tampilkan target
            document.getElementById(id).classList.add('show');
        }

        window.startGame = function() {
            currentLevel = 0;
            loadLevel(0);
            showScreen('game-screen');
        }

        window.goHome = function() {
            stopTimer();
            showScreen('menu-screen');
        }

        window.showLeaderboard = function() {
            renderLb();
            showScreen('lb-screen');
        }

        window.resetGame = function() {
            loadLevel(currentLevel);
        }

        window.nextLevel = function() {
            currentLevel++;
            if(currentLevel >= LEVELS.length) {
                alert("SELAMAT! ANDA MENYELESAIKAN SEMUA LEVEL!");
                goHome();
            } else {
                loadLevel(currentLevel);
            }
        }

        // --- 5. GAME LOGIC ---
        function loadLevel(idx) {
            var lvl = LEVELS[idx];
            gridSize = lvl.size;
            
            // Deep Copy Grid
            gameGrid = JSON.parse(JSON.stringify(lvl.grid));
            gamePaths = {};
            activeColor = null;
            isCompleted = false;

            // Init Paths
            for(var r=0; r<gridSize; r++) {
                for(var c=0; c<gridSize; c++) {
                    var val = gameGrid[r][c];
                    if(val > 0) gamePaths[val] = [];
                }
            }

            // UI
            document.getElementById('disp-level').innerText = idx + 1;
            document.getElementById('win-overlay').classList.add('hidden');
            
            resizeGame();
            startTimer();
            saveData(idx);
        }

        function resizeGame() {
            if(!canvas) return;
            var maxWidth = Math.min(window.innerWidth - 40, 400);
            canvas.width = maxWidth;
            canvas.height = maxWidth;
            canvas.style.width = maxWidth + "px";
            canvas.style.height = maxWidth + "px";
            cellSize = maxWidth / gridSize;
            render();
        }

        // --- 6. INPUT HANDLERS ---
        function getPos(e) {
            var rect = canvas.getBoundingClientRect();
            return {
                c: Math.floor((e.clientX - rect.left) / cellSize),
                r: Math.floor((e.clientY - rect.top) / cellSize)
            };
        }

        function inputStart(e) {
            if(isCompleted) return;
            var p = getPos(e);
            if(p.r < 0 || p.r >= gridSize || p.c < 0 || p.c >= gridSize) return;

            var baseGrid = LEVELS[currentLevel].grid;
            var val = baseGrid[p.r][p.c] || gameGrid[p.r][p.c];

            if(val > 0) {
                activeColor = val;
                gamePaths[val] = [{r: p.r, c: p.c}];
                updateGrid();
                render();
            }
        }

        function inputMove(e) {
            if(!activeColor || isCompleted) return;
            var p = getPos(e);
            if(p.r < 0 || p.r >= gridSize || p.c < 0 || p.c >= gridSize) return;

            var path = gamePaths[activeColor];
            var last = path[path.length-1];

            // Cek tetangga
            if((last.r !== p.r || last.c !== p.c) && (Math.abs(last.r - p.r) + Math.abs(last.c - p.c) === 1)) {
                
                var baseGrid = LEVELS[currentLevel].grid;
                var targetBase = baseGrid[p.r][p.c];
                var targetCurr = gameGrid[p.r][p.c];

                // Backtrack
                var idx = -1;
                for(var i=0; i<path.length; i++) {
                    if(path[i].r === p.r && path[i].c === p.c) idx = i;
                }

                if(idx !== -1) {
                    gamePaths[activeColor] = path.slice(0, idx+1);
                    updateGrid();
                    render();
                    return;
                }

                // Move Forward (Target Kosong atau Endpoint Sendiri)
                if((targetCurr === 0 || targetCurr === activeColor) && (targetBase === 0 || targetBase === activeColor)) {
                    path.push({r: p.r, c: p.c});
                    updateGrid();
                    render();
                    checkWin();
                }
            }
        }

        function inputEnd() { activeColor = null; }

        function updateGrid() {
            var base = LEVELS[currentLevel].grid;
            // Clear dynamic
            for(var r=0; r<gridSize; r++) {
                for(var c=0; c<gridSize; c++) {
                    if(base[r][c] === 0) gameGrid[r][c] = 0;
                }
            }
            // Fill paths
            for(var key in gamePaths) {
                var cId = parseInt(key);
                var p = gamePaths[key];
                for(var i=0; i<p.length; i++) {
                    gameGrid[p[i].r][p[i].c] = cId;
                }
            }
        }

        // --- 7. RENDERER ---
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Grid Lines
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for(var i=0; i<=gridSize; i++) {
                var p = i * cellSize;
                ctx.moveTo(p, 0); ctx.lineTo(p, canvas.height);
                ctx.moveTo(0, p); ctx.lineTo(canvas.width, p);
            }
            ctx.stroke();

            // Paths
            for(var key in gamePaths) {
                var path = gamePaths[key];
                if(path.length < 2) continue;
                
                ctx.strokeStyle = COLORS[key];
                ctx.lineWidth = cellSize * 0.45;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.beginPath();
                ctx.moveTo(path[0].c * cellSize + cellSize/2, path[0].r * cellSize + cellSize/2);
                for(var j=1; j<path.length; j++) {
                    ctx.lineTo(path[j].c * cellSize + cellSize/2, path[j].r * cellSize + cellSize/2);
                }
                ctx.stroke();
            }

            // Endpoints
            var base = LEVELS[currentLevel].grid;
            for(var r=0; r<gridSize; r++) {
                for(var c=0; c<gridSize; c++) {
                    var val = base[r][c];
                    if(val > 0) {
                        var cx = c * cellSize + cellSize/2;
                        var cy = r * cellSize + cellSize/2;
                        ctx.fillStyle = COLORS[val];
                        ctx.beginPath();
                        ctx.arc(cx, cy, cellSize * 0.3, 0, Math.PI*2);
                        ctx.fill();
                        
                        // Dot
                        ctx.fillStyle = 'rgba(255,255,255,0.3)';
                        ctx.beginPath();
                        ctx.arc(cx, cy, cellSize * 0.1, 0, Math.PI*2);
                        ctx.fill();
                    }
                }
            }
        }

        // --- 8. WIN CHECK (FULL GRID) ---
        function checkWin() {
            var base = LEVELS[currentLevel].grid;
            var full = true;
            var connected = true;

            // 1. Cek Full
            for(var r=0; r<gridSize; r++) {
                for(var c=0; c<gridSize; c++) {
                    if(base[r][c] === 0 && gameGrid[r][c] === 0) full = false;
                }
            }

            // 2. Cek Koneksi (Sederhana: Path panjangnya > 1)
            // Seharusnya cek ujung ke ujung, tapi untuk UX smooth, full grid biasanya cukup
            var colorsNeeded = 0;
            var colorsDone = 0;
            // Hitung manual karena Set di ES5 kadang rewel di webview tua
            var foundColors = {};
            
            for(var r=0; r<gridSize; r++) {
                for(var c=0; c<gridSize; c++) {
                    var v = base[r][c];
                    if(v > 0) foundColors[v] = true;
                }
            }
            
            for(var k in foundColors) {
                var p = gamePaths[k];
                if(!p || p.length < 2) connected = false;
                
                // Cek ujung ke ujung simpel
                // (Ini logic sederhana, asumsi pemain tidak muter-muter)
            }

            if(full && connected) {
                isCompleted = true;
                stopTimer();
                setTimeout(function() {
                    document.getElementById('win-overlay').classList.remove('hidden');
                    saveData(currentLevel + 1);
                }, 300);
            }
        }

        // --- 9. UTILS ---
        function startTimer() {
            stopTimer();
            startTime = Date.now();
            timerInterval = setInterval(function() {
                var d = Math.floor((Date.now() - startTime) / 1000);
                var m = Math.floor(d/60).toString().padStart(2,'0');
                var s = (d%60).toString().padStart(2,'0');
                document.getElementById('disp-timer').innerText = m + ":" + s;
            }, 1000);
        }

        function stopTimer() { if(timerInterval) clearInterval(timerInterval); }

        function saveData(lvl) {
            var scores = JSON.parse(localStorage.getItem('flowScoresV12') || "[]");
            var found = false;
            for(var i=0; i<scores.length; i++) {
                if(scores[i].name === 'YOU') {
                    if(lvl > scores[i].lvl) scores[i].lvl = lvl;
                    found = true;
                }
            }
            if(!found) scores.push({name: 'YOU', lvl: lvl});
            localStorage.setItem('flowScoresV12', JSON.stringify(scores));
        }

        function renderLb() {
            var scores = JSON.parse(localStorage.getItem('flowScoresV12') || "[]");
            if(scores.length === 0) scores = [{name: 'PRO', lvl: 50}];
            scores.sort(function(a,b){return b.lvl - a.lvl});
            
            var list = document.getElementById('lb-list');
            list.innerHTML = '';
            
            for(var i=0; i<scores.length; i++) {
                var s = scores[i];
                var div = document.createElement('div');
                div.className = "grid grid-cols-3 p-4 border-b border-slate-700 text-sm";
                var col = (i===0) ? 'text-yellow-400 font-bold' : 'text-slate-300';
                div.innerHTML = '<div class="text-center '+col+'">#'+(i+1)+'</div><div class="'+col+'">'+s.name+'</div><div class="text-right text-emerald-400 font-mono">Lvl '+s.lvl+'</div>';
                list.appendChi
