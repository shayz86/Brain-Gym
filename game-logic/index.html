<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Kubus Logika - Time Attack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #0f172a; touch-action: none; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* UI Layers */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        #overlay, #confirm-modal, #leaderboard-modal { 
            position: absolute; inset: 0; z-index: 9999; 
            background-color: rgba(15, 23, 42, 0.95); 
            display: flex; align-items: center; justify-content: center;
        }
        
        .interactive { pointer-events: auto; cursor: pointer; }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
            border-radius: 16px;
        }

        .timer-bar { transition: width 1s linear; }
        .timer-warning { animation: pulse-red 0.5s infinite; }
        @keyframes pulse-red { 0%,100%{background-color:#ef4444} 50%{background-color:#7f1d1d} }

        .scroller::-webkit-scrollbar { width: 4px; }
        .scroller::-webkit-scrollbar-track { background: #1e293b; }
        .scroller::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="ui-layer" class="flex flex-col justify-between p-4 h-full hidden">
        <div class="flex flex-col w-full max-w-lg mx-auto pointer-events-none gap-2">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-black italic text-white tracking-tighter">KUBUS <span class="text-yellow-400">LOGIKA</span></h1>
                    <div class="text-xs text-gray-400">LEVEL <span id="hud-level" class="text-white font-bold text-lg">1</span></div>
                </div>
                <button onclick="window.askExit()" class="interactive bg-slate-700/50 w-10 h-10 rounded-full flex items-center justify-center border border-slate-500 text-white hover:bg-red-500/80 transition">
                    ‚úï
                </button>
            </div>
            
            <div class="w-full h-3 bg-slate-800 rounded-full overflow-hidden border border-slate-700 relative">
                <div id="timer-fill" class="h-full bg-gradient-to-r from-green-500 to-emerald-400 w-full timer-bar"></div>
                <div id="timer-text" class="absolute inset-0 flex items-center justify-center text-[9px] font-bold text-white drop-shadow-md">00:00</div>
            </div>
        </div>

        <div class="text-center pb-2 opacity-60 pointer-events-none">
            <p class="text-[10px] text-gray-400 uppercase tracking-widest">Swipe Cepat untuk Bergerak</p>
        </div>
    </div>

    <div id="overlay">
        <div class="glass-panel p-8 max-w-sm w-full mx-4 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-pink-500"></div>
            
            <h2 class="text-3xl font-black text-white mb-2 mt-2">SIAP MAIN?</h2>
            <p class="text-gray-400 text-sm mb-6">Injak semua lantai jadi <b class="text-yellow-400">EMAS</b>.<br>Waktu makin cepat setiap level!</p>
            
            <button onclick="window.startGame()" class="interactive w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg mb-3 ring-1 ring-white/20 transition-transform active:scale-95">
                MULAI (LEVEL 1)
            </button>
            
            <button onclick="window.showLeaderboard()" class="interactive w-full bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 px-6 rounded-xl border border-slate-600 mb-3 transition">
                üèÜ TOP SKOR
            </button>

            <a href="../index.html" class="block w-full bg-transparent hover:bg-white/5 text-gray-400 text-xs py-2 rounded-lg transition">
                ‚¨Ö KEMBALI KE REPO UTAMA
            </a>
        </div>
    </div>

    <div id="game-over-modal" style="display:none;" class="fixed inset-0 z-[10000] bg-slate-900/95 flex items-center justify-center">
        <div class="glass-panel p-8 max-w-sm w-full mx-4 text-center border-t-4 border-t-red-500" id="go-panel">
            <h2 id="go-title" class="text-3xl font-black text-white mb-2">GAME OVER</h2>
            <p id="go-desc" class="text-gray-300 text-sm mb-6">Waktu Habis!</p>
            <div id="go-score" class="text-4xl font-mono text-yellow-400 font-bold mb-6">LVL 5</div>

            <button onclick="window.restartGame()" class="interactive w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg mb-3">
                MAIN LAGI (Level 1)
            </button>
            <button onclick="window.toMainMenu()" class="interactive w-full bg-slate-700 text-white font-semibold py-3 rounded-xl">
                KE MENU UTAMA
            </button>
        </div>
    </div>

    <div id="confirm-modal" style="display:none;">
        <div class="glass-panel p-6 max-w-xs w-full text-center">
            <h3 class="text-xl font-bold text-white mb-2">Keluar Permainan?</h3>
            <p class="text-gray-400 text-sm mb-6">Progress level ini akan hilang.</p>
            <div class="flex gap-3">
                <button onclick="document.getElementById('confirm-modal').style.display='none'" class="interactive flex-1 bg-slate-600 text-white py-2 rounded-lg">Batal</button>
                <button onclick="window.toMainMenu()" class="interactive flex-1 bg-red-600 text-white py-2 rounded-lg font-bold">YA, KELUAR</button>
            </div>
        </div>
    </div>

    <div id="leaderboard-modal" style="display:none;">
        <div class="glass-panel p-6 max-w-sm w-full h-3/4 flex flex-col relative">
            <button onclick="document.getElementById('leaderboard-modal').style.display='none'" class="interactive absolute top-4 right-4 text-gray-400 hover:text-white">‚úï</button>
            <h2 class="text-2xl font-bold text-yellow-400 mb-4 text-center">TOP 10 RECORDS</h2>
            <div id="lb-list" class="flex-1 overflow-y-auto scroller space-y-2 pr-2"></div>
            <button onclick="window.clearData()" class="interactive mt-4 text-[10px] text-red-400 underline">Reset Data</button>
        </div>
    </div>

    <div id="game-container"></div>

    <script>
        // --- LOGIKA TOMBOL BACK HP ---
        // Menjebak tombol back agar tidak langsung keluar halaman
        // Tapi memanggil fungsi askExit() (sama seperti tombol X)
        history.pushState(null, null, location.href);
        window.onpopstate = function () {
            history.pushState(null, null, location.href);
            window.askExit();
        };

        // --- GLOBAL STATE ---
        window.isGameActive = false;
        window.currentLevel = 0;
        window.timerInterval = null;
        window.timeLeft = 0;
        window.maxTime = 0;
        const LB_KEY = 'kubus_top_scores';
        
        // --- LEADERBOARD ---
        function saveScore(lvl) {
            let data = JSON.parse(localStorage.getItem(LB_KEY) || '[]');
            let date = new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'short'});
            data.push({ l: lvl, d: date });
            data.sort((a, b) => b.l - a.l);
            data = data.slice(0, 10);
            localStorage.setItem(LB_KEY, JSON.stringify(data));
        }

        window.showLeaderboard = function() {
            const list = document.getElementById('lb-list');
            const data = JSON.parse(localStorage.getItem(LB_KEY) || '[]');
            if(data.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 mt-10">Belum ada rekor.</div>';
            } else {
                let html = '';
                data.forEach((item, idx) => {
                    let color = idx === 0 ? 'text-yellow-400' : (idx===1?'text-gray-300':(idx===2?'text-orange-400':'text-white'));
                    let bg = idx % 2 === 0 ? 'bg-white/5' : 'bg-transparent';
                    html += `<div class="flex justify-between items-center p-3 rounded-lg ${bg}"><div class="flex items-center gap-3"><span class="font-mono font-bold w-6 ${color}">#${idx+1}</span><span class="text-sm text-gray-300">${item.d}</span></div><span class="font-bold text-emerald-400">Level ${item.l}</span></div>`;
                });
                list.innerHTML = html;
            }
            document.getElementById('leaderboard-modal').style.display = 'flex';
        };
        
        window.clearData = function() {
            if(confirm("Hapus semua data skor?")) {
                localStorage.removeItem(LB_KEY);
                window.showLeaderboard();
            }
        };

        // --- UI CONTROLS ---
        window.startGame = function() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('game-over-modal').style.display = 'none';
            document.getElementById('ui-layer').classList.remove('hidden');
            window.isGameActive = true;
            window.currentLevel = 0;
            if(typeof window.loadLevel === 'function') window.loadLevel(0);
        };

        // Fungsi ini dipanggil oleh Tombol X DAN Tombol Back HP
        window.askExit = function() {
            if(window.isGameActive) {
                const modal = document.getElementById('confirm-modal');
                // Jika modal sudah terbuka, tutup (UX Back button standar)
                if(modal.style.display === 'flex') {
                    modal.style.display = 'none';
                } else {
                    modal.style.display = 'flex';
                }
            }
        };

        window.toMainMenu = function() {
            window.isGameActive = false;
            clearInterval(window.timerInterval);
            document.getElementById('confirm-modal').style.display = 'none';
            document.getElementById('game-over-modal').style.display = 'none';
            document.getElementById('ui-layer').classList.add('hidden');
            document.getElementById('overlay').style.display = 'flex';
        };

        window.restartGame = function() {
            window.startGame();
        };

        window.nextLevelUI = function() {
            window.currentLevel++;
            window.loadLevel(window.currentLevel);
        };
        
        window.gameOver = function(isWin) {
            window.isGameActive = false;
            clearInterval(window.timerInterval);
            const modal = document.getElementById('game-over-modal');
            const title = document.getElementById('go-title');
            const desc = document.getElementById('go-desc');
            const score = document.getElementById('go-score');
            const panel = document.getElementById('go-panel');

            modal.style.display = 'flex';
            
            if(isWin) {
                panel.className = "glass-panel p-8 max-w-sm w-full mx-4 text-center border-t-4 border-t-yellow-400";
                title.innerText = "TAMAT!";
                title.className = "text-3xl font-black text-yellow-400 mb-2";
                desc.innerText = "Selamat! Kamu Master Logika.";
                score.innerText = "50 LEVEL";
                saveScore(50);
            } else {
                panel.className = "glass-panel p-8 max-w-sm w-full mx-4 text-center border-t-4 border-t-red-500";
                title.innerText = "WAKTU HABIS";
                title.className = "text-3xl font-black text-red-500 mb-2";
                desc.innerText = "Jangan menyerah, coba lagi!";
                score.innerText = "SKOR: LEVEL " + (window.currentLevel + 1);
                saveScore(window.currentLevel + 1);
            }
        };

        // --- GAME ENGINE (Three.js) ---
        try {
            let scene, camera, renderer, playerMesh;
            let tileMeshes = [];
            let levels = [];
            let currentMap = [];
            let playerPos = { x: 0, z: 0 };
            let isMoving = false;
            let startMouse = { x: 0, y: 0 };

            const TILE_SIZE = 1.2;
            const TOTAL_LEVELS = 50;
            const THEMES = [
                { bg: 0x0f172a, tile: 0x334155, on: 0xfacc15, player: 0x38bdf8 },
                { bg: 0x2a0a0a, tile: 0x552222, on: 0xff5500, player: 0xffaa00 },
                { bg: 0x064e3b, tile: 0x065f46, on: 0x34d399, player: 0xa7f3d0 },
                { bg: 0x1e1b4b, tile: 0x312e81, on: 0x818cf8, player: 0xc084fc },
                { bg: 0x000000, tile: 0x262626, on: 0xffffff, player: 0xff0055 }
            ];

            function init() {
                const container = document.getElementById('game-container');
                scene = new THREE.Scene();
                
                // Static Isometric Camera
                const aspect = window.innerWidth / window.innerHeight;
                camera = new THREE.PerspectiveCamera(45, aspect, 0.1, 100);
                camera.position.set(10, 10, 10); 
                camera.lookAt(0, 0, 0);

                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.shadowMap.enabled = true;
                container.appendChild(renderer.domElement);

                const ambient = new THREE.AmbientLight(0xffffff, 0.5);
                scene.add(ambient);
                const sun = new THREE.DirectionalLight(0xffffff, 0.8);
                sun.position.set(5, 15, 5);
                sun.castShadow = true;
                scene.add(sun);

                generateLevels();
                window.addEventListener('resize', onWindowResize, false);
                setupInputHandlers();
                animate();
            }

            function generateLevels() {
                levels = [
                    { map: [[1,1,1],[1,1,1],[1,1,1]], start: {x:1, z:1} },
                    { map: [[1,1,1],[0,1,0],[0,1,0],[0,1,0]], start: {x:1, z:3} },
                    { map: [[1,0,1,1,1],[1,1,1,0,1],[0,0,1,1,1]], start: {x:0, z:0} },
                    { map: [[1,1,1,1],[1,0,0,1],[1,0,0,1],[1,1,1,1]], start: {x:0, z:0} },
                    { map: [[1,1,1,0,1],[1,0,1,0,1],[1,0,1,1,1],[1,0,0,0,0],[1,1,1,1,1]], start: {x:0, z:0} }
                ];
                for (let i = 5; i < TOTAL_LEVELS; i++) {
                    const size = Math.min(8, 4 + Math.floor(i / 10)); 
                    const minPath = 8 + i; 
                    let map, startPos, success = false, attempts = 0;
                    while(!success && attempts < 50) {
                        attempts++;
                        map = Array(size).fill().map(() => Array(size).fill(0));
                        let curr = { x: Math.floor(Math.random()*(size-2))+1, y: Math.floor(Math.random()*(size-2))+1 };
                        startPos = { ...curr };
                        map[curr.y][curr.x] = 1;
                        let pathLen = 1;
                        for(let steps=0; steps<minPath*1.5; steps++) {
                            let dirs = [{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0}];
                            let d = dirs[Math.floor(Math.random()*4)];
                            let nx = curr.x+d.x, ny = curr.y+d.y;
                            if(nx>=0 && nx<size && ny>=0 && ny<size) {
                                if(map[ny][nx]===0) pathLen++;
                                map[ny][nx] = 1;
                                curr = {x:nx, y:ny};
                            }
                        }
                        if(pathLen >= minPath) success = true;
                    }
                    levels.push({ map: map, start: {x: startPos.x, z: startPos.y} });
                }
            }

            window.loadLevel = function(idx) {
                if(idx >= levels.length) { window.gameOver(true); return; }
                if(playerMesh) scene.remove(playerMesh);
                tileMeshes.forEach(m => scene.remove(m));
                tileMeshes = [];

                const levelData = levels[idx];
                currentMap = JSON.parse(JSON.stringify(levelData.map));
                playerPos = { ...levelData.start };
                const theme = THEMES[Math.floor(idx / 10) % THEMES.length];
                scene.background = new THREE.Color(theme.bg);
                
                const h = currentMap.length; 
                const w = currentMap[0].length;
                const offX = (w*TILE_SIZE)/2 - (TILE_SIZE/2);
                const offZ = (h*TILE_SIZE)/2 - (TILE_SIZE/2);
                const geo = new THREE.BoxGeometry(TILE_SIZE*0.9, 0.2, TILE_SIZE*0.9);
                let tileCount = 0;

                for(let z=0; z<h; z++) {
                    for(let x=0; x<w; x++) {
                        if(currentMap[z][x] !== 0) {
                            tileCount++;
                            const mat = new THREE.MeshStandardMaterial({ color: theme.tile, roughness:0.2 });
                            const tile = new THREE.Mesh(geo, mat);
                            tile.position.set((x*TILE_SIZE)-offX, -0.1, (z*TILE_SIZE)-offZ);
                            tile.userData = { gridX: x, gridZ: z, state: false, colorOn: theme.on, colorOff: theme.tile };
                            tile.receiveShadow = true;
                            scene.add(tile);
                            tileMeshes.push(tile);
                        }
                    }
                }

                const pGeo = new THREE.SphereGeometry(TILE_SIZE*0.35, 32, 32);
                const pMat = new THREE.MeshStandardMaterial({ color: theme.player, emissive: theme.player, emissiveIntensity: 0.5 });
                playerMesh = new THREE.Mesh(pGeo, pMat);
                playerMesh.castShadow = true;
                const startTile = getTileMesh(playerPos.x, playerPos.z);
                if(startTile) {
                    playerMesh.position.copy(startTile.position);
                    playerMesh.position.y = TILE_SIZE*0.5;
                    toggleTile(startTile, true);
                }
                scene.add(playerMesh);

                const maxDim = Math.max(w, h);
                const zoom = 8 + (maxDim * 1.5);
                camera.position.set(zoom, zoom, zoom);
                camera.lookAt(0,0,0);
                document.getElementById('hud-level').innerText = (idx + 1);

                let timePerTile = Math.max(0.3, 0.8 - (idx * 0.01)); 
                let totalTime = Math.floor(tileCount * timePerTile) + 5; 
                startTimer(totalTime);
            }

            function startTimer(seconds) {
                clearInterval(window.timerInterval);
                window.maxTime = seconds;
                window.timeLeft = seconds;
                const bar = document.getElementById('timer-fill');
                const txt = document.getElementById('timer-text');
                bar.classList.remove('bg-red-600', 'timer-warning');
                bar.classList.add('bg-gradient-to-r', 'from-green-500', 'to-emerald-400');
                
                updateTimerUI();
                window.timerInterval = setInterval(() => {
                    if(!window.isGameActive) return;
                    window.timeLeft--;
                    updateTimerUI();
                    if(window.timeLeft <= 0) window.gameOver(false);
                }, 1000);
            }

            function updateTimerUI() {
                const bar = document.getElementById('timer-fill');
                const txt = document.getElementById('timer-text');
                let pct = (window.timeLeft / window.maxTime) * 100;
                bar.style.width = pct + "%";
                txt.innerText = window.timeLeft + "s";
                if(pct < 30) {
                    bar.classList.remove('bg-gradient-to-r', 'from-green-500', 'to-emerald-400');
                    bar.classList.add('bg-red-600', 'timer-warning');
                }
            }

            function getTileMesh(gx, gz) { return tileMeshes.find(t => t.userData.gridX === gx && t.userData.gridZ === gz); }
            
            function toggleTile(tile, forceOn=false) {
                if (!tile) return;
                tile.userData.state = !tile.userData.state;
                if(forceOn) tile.userData.state = true;
                const isOn = tile.userData.state;
                tile.material.color.setHex(isOn ? tile.userData.colorOn : tile.userData.colorOff);
                tile.material.emissive.setHex(isOn ? tile.userData.colorOn : 0x000000);
                tile.material.emissiveIntensity = isOn ? 0.6 : 0;
                if(isOn) {
                    let f=0;
                    const anim = () => { if(f<5) { tile.position.y -= 0.05; f++; requestAnimationFrame(anim); } else tile.position.y = -0.1; };
                    anim();
                }
            }

            function checkWin() {
                const all = tileMeshes.length;
                const active = tileMeshes.filter(t => t.userData.state).length;
                if(active === all) { clearInterval(window.timerInterval); setTimeout(() => { window.nextLevelUI(); }, 500); }
            }

            function move(dx, dz) {
                if(isMoving || !window.isGameActive) return;
                const nx = playerPos.x + dx;
                const nz = playerPos.z + dz;
                const targetTile = getTileMesh(nx, nz);
                if(!targetTile) return;
                if(targetTile.userData.state === true) { window.gameOver(false); return; }

                isMoving = true;
                playerPos.x = nx; playerPos.z = nz;
                const pStart = playerMesh.position.clone();
                const pEnd = targetTile.position.clone(); pEnd.y = TILE_SIZE*0.5;
                let t=0;
                const anim = () => {
                    t += 0.15; if(t>1) t=1;
                    playerMesh.position.lerpVectors(pStart, pEnd, t);
                    playerMesh.position.y = (TILE_SIZE*0.5) + Math.sin(t*Math.PI)*0.8;
                    if(t<1) requestAnimationFrame(anim);
                    else { isMoving=false; playerMesh.position.y = TILE_SIZE*0.5; toggleTile(targetTile); checkWin(); }
                };
                anim();
            }

            function setupInputHandlers() {
                const c = document.getElementById('game-container');
                c.addEventListener('touchstart', e => { startMouse.x = e.touches[0].clientX; startMouse.y = e.touches[0].clientY; }, {passive:false});
                c.addEventListener('touchend', e => {
                    const dx = e.changedTouches[0].clientX - startMouse.x;
                    const dy = e.changedTouches[0].clientY - startMouse.y;
                    if(Math.abs(dx) > Math.abs(dy)) { if(Math.abs(dx) > 30) move(dx > 0 ? 1 : -1, 0); } 
                    else { if(Math.abs(dy) > 30) move(0, dy > 0 ? 1 : -1); }
                }, {passive:false});
                // Keyboard Support (Backup)
                window.addEventListener('keydown', e => {
                   if(!window.isGameActive) return;
                   if(e.key==='ArrowUp'||e.key==='w') move(0,-1);
                   if(e.key==='ArrowDown'||e.key==='s') move(0,1);
                   if(e.key==='ArrowLeft'||e.key==='a') move(-1,0);
                   if(e.key==='ArrowRight'||e.key==='d') move(1,0);
                });
            }

            function onWindowResize() {
                if(!camera || !renderer) return;
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            function animate() { requestAnimationFrame(animate); if(renderer && scene && camera) renderer.render(scene, camera); }
            init();

        } catch (err) { console.error(err); }
    </script>
</body>
</html>
